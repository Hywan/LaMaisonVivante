<!DOCTYPE html>

<html lang="fr">
<head>
  <title>Hub — La Maison Vivante</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta http-equiv="content-type" content="text/javascript; charset=utf-8" />
  <meta http-equiv="content-type" content="text/css; charset=utf-8" />
  <meta name="viewport" content="initial-scale=1.0" />
  <meta name="theme-color" content="#b24646" />
  <link rel="icon" type="image/png" href="" />
  <link rel="stylesheet" type="text/css" href="static/style/main.css" />

  <template id="template--nav">
    <style>
      @import "static/style/main.css";
    </style>

    <h1 class="header--title">
      <ol>
        <li><slot name="root">(root)</slot></li>
      </ol>
    </h1>
  </template>

  <template id="template--things">
    <style>
      @import "static/style/main.css";
    </style>

    <div class="things">
      <h2 class="things--location"><span class="heading"><slot name="location">(somewhere)</slot></span></h2>

      <div class="things--list">
        <slot>(none)</slot>
      </div>
    </div>
  </template>

  <template id="template--thing">
    <style>
      @import "static/style/main.css";
    </style>

    <div id="thing-?" class="thing" aria-expanded="false">
      <div class="thing--summary thing--expander">
        <h3 class="thing--name"><slot name="name">(unnamed)</slot></h3>
        <span class="thing--state-icon"><slot name="state-icon">(❓)</slot></span>
        <span class="thing--state-text"><slot name="state-text">(??)</slot></span>
      </div>
      <div class="thing--long">
        <h3 class="thing--name"><slot name="long-name">(unnamed)</slot></h3>
        <slot name="thing">(component)</slot>
      </div>
    </div>
  </template>

  <template id="template--thing-pulse">
    <style>
      @import "static/style/main.css";
    </style>

    <div class="thing--type-pulse">
      <button>Pulser</button>
    </div>
  </template>

  <script>
    function http_put(url, body) {
        return fetch(url, {
            method: 'PUT',
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json',
            },
            body: body,
        })
    }

    window.customElements.define(
        'my-nav',
        class extends HTMLElement {
            constructor() {
                super();
            }

            connectedCallback() {
                let template = document.getElementById('template--nav');
                let template_content = template.content.cloneNode(true);

                this.attachShadow({mode: 'open'})
                    .appendChild(template_content);
            }

            enter(name, onclick) {
                let root = this.shadowRoot;

                var link = document.createElement('a');
                link.setAttribute('href', '#');
                link.addEventListener('click', onclick);
                link.appendChild(document.createTextNode(name));

                var item = document.createElement('li');
                item.appendChild(link);

                let list = root.querySelector('ol');
                list.appendChild(item);
            }

            leave() {
                let last = this.shadowRoot.querySelector('li:last-child');

                if (last) {
                    last.parentNode.removeChild(last);
                }
            }
        }
    );

    window.customElements.define(
        'my-things',
        class extends HTMLElement {
            constructor() {
                super();
            }

            connectedCallback() {
                let template = document.getElementById('template--things');
                let template_content = template.content.cloneNode(true);

                this.attachShadow({mode: 'closed'})
                    .appendChild(template_content);
            }
        }
    );

    window.customElements.define(
        'my-thing',
        new function() {
            let thing_index = 0;

            return class extends HTMLElement {
                constructor() {
                    super();
                }

                connectedCallback() {
                    const template = document.getElementById('template--thing');
                    const template_content = template.content.cloneNode(true);

                    const thing = template_content.querySelector('.thing');
                    thing.setAttribute('id', 'thing-' + thing_index);
                    thing_index += 1;

                    const shadow_root = this.attachShadow({mode: 'open'})
                        .appendChild(template_content);

                    const self = this;

                    thing.querySelector('.thing--expander').addEventListener(
                        'click',
                        () => {
                            const nav = document.getElementById('nav');
                            const leaving = () => {
                                thing.setAttribute('aria-expanded', 'false')
                                nav.leave();
                            };

                            if (thing.getAttribute('aria-expanded') == 'false') {
                                const thing_name = self.querySelector('span[slot="name"]').textContent;

                                thing.setAttribute('aria-expanded', 'true');
                                nav.enter('Tous les objets', leaving);
                            }
                        }
                    );
                }
            };
        }
    );

    window.customElements.define(
        'my-thing--pulse',
        class extends HTMLElement {
            constructor() {
                super();
            }

            connectedCallback() {
                const template = document.getElementById('template--thing-pulse');
                const template_content = template.content.cloneNode(true);

                const button = template_content.querySelector('.thing--type-pulse');

                const shadow_root = this.attachShadow({mode: 'open'})
                    .appendChild(template_content);

                const self = this;
                const base = self.getAttribute('data-base').replace(/\/+$/, '');
                const url = base + '/properties/pulse';

                button.addEventListener(
                    'click',
                    () => {
                        http_put(url, '{"pulse": true}')
                    }
                );
            }
        }
    );
  </script>
</head>
<body>
  <header class="header--container">
    <div class="header">
      <my-nav id="nav" role="nav">
        <span slot="root">La Maison Vivante</span>
      </my-nav>
      <span id="header--details">
      </span>
    </div>
  </header>

  <main>
    <my-things>
      <span slot="location">Pièce de vie</span>

      <my-thing>
        <span slot="name">Général</span>
        <span slot="long-name">Espace de vie</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/5" />
      </my-thing>

      <my-thing>
        <span slot="name">Table</span>
        <span slot="long-name">Table à manger</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/7" />
      </my-thing>

      <my-thing>
        <span slot="name">Îlot</span>
        <span slot="long-name">Îlot de cuisine</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/8" />
      </my-thing>

      <my-thing>
        <span slot="name">Cuisine</span>
        <span slot="long-name">Niche de la cuisine</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/8" />
      </my-thing>

      <my-thing>
        <span slot="name">Canapé</span>
        <span slot="long-name">Canapé</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/6" />
      </my-thing>

      <my-thing>
        <span slot="name">Entrée</span>
        <span slot="long-name">Entrée</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/4" />
      </my-thing>
    </my-things>

    <my-things>
      <span slot="location">Salle de bain enfants</span>

      <my-thing>
        <span slot="name">S. de Bain</span>
        <span slot="long-name">Salle de bain des enfants</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/1" />
      </my-thing>

      <my-thing>
        <span slot="name">Buanderie</span>
        <span slot="long-name">Buanderie</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/0" />
      </my-thing>
    </my-things>

    <my-things>
      <span slot="location">Chambres enfants</span>

      <my-thing>
        <span slot="name">Louise</span>
        <span slot="long-name">Chambre de Louise</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/2" />
      </my-thing>

      <my-thing>
        <span slot="name">Éli</span>
        <span slot="long-name">Chambre d'Éli</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/3" />
      </my-thing>
    </my-things>

    <my-things>
      <span slot="location">Suite parentale</span>

      <my-thing>
        <span slot="name">Chambre</span>
        <span slot="long-name">Chambre parentale</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/12" />
      </my-thing>

      <my-thing>
        <span slot="name">Lit</span>
        <span slot="long-name">Lit parental</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/10" />
      </my-thing>

      <my-thing>
        <span slot="name">S. de Bain</span>
        <span slot="long-name">Salle de bain des parents</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/11" />
      </my-thing>
    </my-things>

    <my-things>
      <span slot="location">Serre</span>

      <my-thing>
        <span slot="name">Serre</span>
        <span slot="long-name">Serre</span>
        <span slot="state-icon">💡</span>
        <span slot="state-text">lumière</span>
        <my-thing--pulse
          slot="thing"
          data-base="http://192.168.1.128:8094/12" />
      </my-thing>
    </my-things>

    <!--
    <section id="dashboards" style="background: #f4f5f5">
      <style>
        iframe {
            min-width: 100%;
            min-height: 300px;
            border: 0;
        }
      </style>
      <h2>Dashboards</h2>

      <h3>Électricité</h3>

      <iframe src="http://192.168.1.128:3000/d-solo/Mxk-7RWgk/live?orgId=1&refresh=10s&theme=light&panelId=6"></iframe>
      <iframe src="http://192.168.1.128:3000/d-solo/Mxk-7RWgk/live?orgId=1&refresh=10s&theme=light&panelId=10"></iframe>
      <iframe src="http://192.168.1.128:3000/d-solo/Mxk-7RWgk/live?orgId=1&refresh=10s&theme=light&panelId=12"></iframe>
      <iframe src="http://192.168.1.128:3000/d-solo/Mxk-7RWgk/live?orgId=1&refresh=10s&theme=light&panelId=8"></iframe>
      <iframe src="http://192.168.1.128:3000/d-solo/Mxk-7RWgk/live?orgId=1&refresh=10s&theme=light&panelId=26"></iframe>
      <iframe src="http://192.168.1.128:3000/d-solo/Mxk-7RWgk/live?orgId=1&refresh=10s&theme=light&panelId=4"></iframe>

      <h3>Ventilation</h3>

      <iframe src="http://192.168.1.128:3000/d-solo/Mxk-7RWgk/live?orgId=1&refresh=10s&theme=light&panelId=20"></iframe>
      <iframe src="http://192.168.1.128:3000/d-solo/Mxk-7RWgk/live?orgId=1&refresh=10s&theme=light&panelId=24"></iframe>

      <h3>Eau chaude sanitaire</h3>

      <iframe src="http://192.168.1.128:3000/d-solo/Mxk-7RWgk/live?orgId=1&refresh=10s&theme=light&panelId=22"></iframe>
    </section>
    -->
  </main>
</body>
</html>
